<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-section.success {
            border-color: #4CAF50;
            background-color: #f1f8e9;
        }
        .test-section.error {
            border-color: #f44336;
            background-color: #ffebee;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .response {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196F3;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        .user-info {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        input {
            width: 300px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üîê Authentication Debug Tool</h1>
    <p>Test authentication status and debug order API issues</p>

    <div class="test-section">
        <h3>1. Check Current Authentication Status</h3>
        <button onclick="checkAuthStatus()">Check Auth Status</button>
        <div id="auth-status-response" class="response"></div>
    </div>

    <div class="test-section">
        <h3>2. Login with Test Credentials</h3>
        <label>Email:</label>
        <input type="email" id="loginEmail" value="test@example.com" placeholder="Enter email">
        <label>Password:</label>
        <input type="password" id="loginPassword" value="password123" placeholder="Enter password">
        <br>
        <button onclick="testLogin()">Login</button>
        <div id="login-response" class="response"></div>
    </div>

    <div class="test-section">
        <h3>3. Test Orders API with Authentication</h3>
        <button onclick="testOrdersAPI()">Test GET /orders/my-orders</button>
        <button onclick="testAdminOrdersAPI()">Test GET /orders (Admin)</button>
        <div id="orders-test-response" class="response"></div>
    </div>

    <div class="test-section">
        <h3>4. Debug Session Storage</h3>
        <button onclick="debugSessionStorage()">Check Session Storage</button>
        <button onclick="clearSession()">Clear Session</button>
        <div id="session-debug-response" class="response"></div>
    </div>

    <div class="test-section">
        <h3>5. Test Backend Health</h3>
        <button onclick="testBackendHealth()">Check Backend Status</button>
        <div id="backend-health-response" class="response"></div>
    </div>

    <script type="module">
        // Import utilities
        import { getAuthHeaders } from './src/utils/api/base.js';
        import { login } from './src/utils/api/auth.js';
        import { getUserOrders, getAllOrders } from './src/utils/api/orders.js';
        import { API_CONFIG } from './src/utils/constants/api.js';

        // Utility functions
        function displayResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            const section = element.parentElement;
            
            if (isError) {
                element.textContent = `ERROR: ${data}`;
                section.className = 'test-section error';
            } else {
                element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
                section.className = 'test-section success';
            }
        }

        async function makeRequest(endpoint, options = {}) {
            const url = `${API_CONFIG.BASE_URL}${endpoint}`;
            console.log(`Making request to: ${url}`);
            
            const defaultOptions = {
                method: 'GET',
                headers: getAuthHeaders(),
                ...options
            };

            console.log('Request options:', defaultOptions);

            const response = await fetch(url, defaultOptions);
            console.log('Response status:', response.status);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`${response.status}: ${errorText}`);
            }

            return await response.json();
        }

        // Global functions for buttons
        window.checkAuthStatus = function() {
            try {
                const token = sessionStorage.getItem('token');
                const user = sessionStorage.getItem('user');
                const isAdmin = sessionStorage.getItem('isAdmin');
                
                const headers = getAuthHeaders();
                
                const status = {
                    hasToken: !!token,
                    tokenPreview: token ? `${token.substring(0, 20)}...` : 'None',
                    hasUser: !!user,
                    user: user ? JSON.parse(user) : null,
                    isAdmin: isAdmin === 'true',
                    headers: headers
                };

                if (token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        status.tokenPayload = payload;
                        status.tokenExpired = payload.exp && payload.exp * 1000 < Date.now();
                    } catch (e) {
                        status.tokenParseError = e.message;
                    }
                }

                displayResponse('auth-status-response', status);
            } catch (error) {
                displayResponse('auth-status-response', error.message, true);
            }
        };

        window.testLogin = async function() {
            try {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                if (!email || !password) {
                    throw new Error('Please enter both email and password');
                }

                const result = await login(email, password);
                displayResponse('login-response', `Login successful!\n${JSON.stringify(result, null, 2)}`);
                
                // Check auth status after login
                setTimeout(() => window.checkAuthStatus(), 500);
            } catch (error) {
                displayResponse('login-response', error.message, true);
            }
        };

        window.testOrdersAPI = async function() {
            try {
                const headers = getAuthHeaders();
                console.log('Testing with headers:', headers);
                
                const orders = await getUserOrders();
                displayResponse('orders-test-response', `User Orders (${orders.length} found):\n${JSON.stringify(orders, null, 2)}`);
            } catch (error) {
                displayResponse('orders-test-response', error.message, true);
            }
        };

        window.testAdminOrdersAPI = async function() {
            try {
                const headers = getAuthHeaders();
                console.log('Testing admin API with headers:', headers);
                
                const orders = await getAllOrders();
                displayResponse('orders-test-response', `Admin Orders (${orders.length} found):\n${JSON.stringify(orders, null, 2)}`);
            } catch (error) {
                displayResponse('orders-test-response', error.message, true);
            }
        };

        window.debugSessionStorage = function() {
            try {
                const sessionData = {};
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    let value = sessionStorage.getItem(key);
                    
                    // Try to parse JSON values
                    try {
                        if (value.startsWith('{') || value.startsWith('[')) {
                            value = JSON.parse(value);
                        }
                    } catch (e) {
                        // Keep as string if not JSON
                    }
                    
                    sessionData[key] = value;
                }

                displayResponse('session-debug-response', sessionData);
            } catch (error) {
                displayResponse('session-debug-response', error.message, true);
            }
        };

        window.clearSession = function() {
            try {
                sessionStorage.clear();
                displayResponse('session-debug-response', 'Session storage cleared successfully');
                
                // Update auth status
                setTimeout(() => window.checkAuthStatus(), 500);
            } catch (error) {
                displayResponse('session-debug-response', error.message, true);
            }
        };

        window.testBackendHealth = async function() {
            try {
                const baseUrl = API_CONFIG.BASE_URL;
                const healthCheck = {
                    baseUrl: baseUrl,
                    timestamp: new Date().toISOString()
                };

                // Test different endpoints
                const endpoints = [
                    '/users',
                    '/products', 
                    '/orders',
                    '/orders/my-orders'
                ];

                for (const endpoint of endpoints) {
                    try {
                        const response = await fetch(`${baseUrl}${endpoint}`, {
                            method: 'HEAD',
                            headers: getAuthHeaders()
                        });
                        healthCheck[endpoint] = {
                            status: response.status,
                            ok: response.ok,
                            statusText: response.statusText
                        };
                    } catch (error) {
                        healthCheck[endpoint] = {
                            error: error.message
                        };
                    }
                }

                displayResponse('backend-health-response', healthCheck);
            } catch (error) {
                displayResponse('backend-health-response', error.message, true);
            }
        };

        // Auto-check auth status on page load
        document.addEventListener('DOMContentLoaded', function() {
            window.checkAuthStatus();
        });
    </script>
</body>
</html>
