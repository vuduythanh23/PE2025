<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‚úÖ Fixed Checkout Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
      }
      .success {
        background-color: rgba(76, 175, 80, 0.2);
        border-color: rgba(76, 175, 80, 0.5);
      }
      .error {
        background-color: rgba(244, 67, 54, 0.2);
        border-color: rgba(244, 67, 54, 0.5);
      }
      .result {
        margin-top: 15px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.2);
        white-space: pre-wrap;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 14px;
      }
      button {
        padding: 12px 20px;
        margin: 10px;
        cursor: pointer;
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        transition: transform 0.2s;
      }
      button:hover {
        transform: translateY(-2px);
      }
      .status {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }
      .status.logged-in {
        background: rgba(76, 175, 80, 0.3);
        border: 1px solid #4caf50;
      }
      .status.logged-out {
        background: rgba(244, 67, 54, 0.3);
        border: 1px solid #f44336;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üõí Fixed Checkout Test</h1>
      <p>
        Testing the improved cart checkout with proper shipping address and
        payment method
      </p>

      <div id="authStatus" class="test-section">
        <h3>üîê Authentication Status</h3>
        <div id="authInfo"></div>
      </div>

      <div class="test-section">
        <h3>‚ú® Test Fixed Checkout</h3>
        <p>
          This test sends cart items with proper shipping address from user
          profile
        </p>
        <button onclick="testFixedCheckout()">üõçÔ∏è Test Checkout</button>
        <div id="checkoutResult" class="result"></div>
      </div>

      <div class="test-section">
        <h3>üì¶ Test Order Fetch</h3>
        <p>Fetch user orders after checkout</p>
        <button onclick="testFetchOrders()">üìã Fetch My Orders</button>
        <div id="ordersResult" class="result"></div>
      </div>

      <div class="test-section">
        <h3>üîß Debug Info</h3>
        <button onclick="showDebugInfo()">üîç Show Debug Info</button>
        <div id="debugResult" class="result"></div>
      </div>
    </div>

    <script type="module">
      // Import the order functions
      import { createOrder, getUserOrders } from "./src/utils/api/orders.js";

      // Check authentication status
      const checkAuthStatus = () => {
        const token = localStorage.getItem("token");
        const user = sessionStorage.getItem("user");
        const authInfo = document.getElementById("authInfo");

        if (token && user) {
          const userData = JSON.parse(user);
          authInfo.innerHTML = `
                    <span class="status logged-in">‚úÖ Logged In</span>
                    <p><strong>User:</strong> ${userData.email || "Unknown"}</p>
                    <p><strong>Name:</strong> ${userData.firstName || ""} ${
            userData.lastName || ""
          }</p>
                    <p><strong>Address:</strong> ${
                      userData.address || "Not set"
                    }</p>
                `;
        } else {
          authInfo.innerHTML = `
                    <span class="status logged-out">‚ùå Not Logged In</span>
                    <p>Please login first. The test will use mock data for authentication.</p>
                `;

          // Set mock user data for testing
          const mockUser = {
            _id: "test_user_123",
            email: "test@example.com",
            firstName: "Test",
            lastName: "User",
            address: "123 Test Street, Test City",
          };
          sessionStorage.setItem("user", JSON.stringify(mockUser));
          sessionStorage.setItem("token", "mock_token_for_testing");
        }
      };

      window.testFixedCheckout = async function () {
        const resultDiv = document.getElementById("checkoutResult");
        try {
          resultDiv.textContent = "üîÑ Processing checkout...";

          // Create test cart items
          const cartItems = [
            {
              _id: "product_123",
              name: "Nike Air Max 90",
              price: 120.0,
              salePrice: 99.99,
              quantity: 1,
              size: "42",
              color: "White/Red",
              images: ["/images/nike-air-max.jpg"],
            },
            {
              _id: "product_456",
              name: "Adidas Ultraboost 22",
              price: 180.0,
              quantity: 2,
              size: "41",
              color: "Black",
              images: ["/images/adidas-ultraboost.jpg"],
            },
          ];

          console.log("üõí Sending cart items:", cartItems);

          const order = await createOrder(cartItems);

          resultDiv.innerHTML = `
‚úÖ <strong>CHECKOUT SUCCESS!</strong>

Order ID: ${order._id || "Generated"}
Status: ${order.orderStatus || "pending"}
Total: $${order.totalAmount || "Calculated"}
Items: ${order.items?.length || cartItems.length} products

üì¶ Order Details:
${JSON.stringify(order, null, 2)}
                `;
          resultDiv.parentElement.className = "test-section success";
        } catch (error) {
          resultDiv.innerHTML = `
‚ùå <strong>CHECKOUT FAILED</strong>

Error: ${error.message}

üîç Debug Info:
- Check if backend orders API is running
- Verify authentication token
- Check shipping address format

Full Error:
${error.stack || error.toString()}
                `;
          resultDiv.parentElement.className = "test-section error";
          console.error("Checkout error:", error);
        }
      };

      window.testFetchOrders = async function () {
        const resultDiv = document.getElementById("ordersResult");
        try {
          resultDiv.textContent = "üîÑ Fetching orders...";

          const orders = await getUserOrders();

          if (orders && orders.length > 0) {
            resultDiv.innerHTML = `
‚úÖ <strong>ORDERS FETCHED!</strong>

Found ${orders.length} order(s):

${orders
  .map(
    (order, index) => `
üì¶ Order #${index + 1}
  - ID: ${order._id?.slice(-8) || "N/A"}
  - Status: ${order.orderStatus || "pending"}
  - Total: $${order.totalAmount || "0.00"}
  - Items: ${order.items?.length || 0}
  - Date: ${
    order.createdAt ? new Date(order.createdAt).toLocaleDateString() : "N/A"
  }
`
  )
  .join("")}

Raw Data:
${JSON.stringify(orders, null, 2)}
                    `;
          } else {
            resultDiv.innerHTML = `
‚ÑπÔ∏è <strong>NO ORDERS FOUND</strong>

This might be because:
- No orders have been created yet
- Orders API is not returning data
- Authentication issues

Response: ${JSON.stringify(orders, null, 2)}
                    `;
          }
          resultDiv.parentElement.className = "test-section success";
        } catch (error) {
          resultDiv.innerHTML = `
‚ùå <strong>FETCH ORDERS FAILED</strong>

Error: ${error.message}

This might be due to:
- Backend orders API not implemented correctly
- Authentication issues
- Network problems

Full Error:
${error.stack || error.toString()}
                `;
          resultDiv.parentElement.className = "test-section error";
          console.error("Fetch orders error:", error);
        }
      };

      window.showDebugInfo = function () {
        const resultDiv = document.getElementById("debugResult");
        const user = JSON.parse(sessionStorage.getItem("user") || "{}");
        const token = sessionStorage.getItem("token");

        resultDiv.innerHTML = `
üîç <strong>DEBUG INFORMATION</strong>

üîê Authentication:
  - Token: ${token ? "Present" : "Missing"}
  - User Data: ${Object.keys(user).length} fields

üë§ User Info:
  - ID: ${user._id || "Not set"}
  - Email: ${user.email || "Not set"}
  - Name: ${user.firstName || ""} ${user.lastName || ""}
  - Address: ${user.address || "Not set"}

üåê API Endpoints:
  - Orders: https://shoe-store-backend-api-88692812562.us-central1.run.app/api/orders
  - My Orders: .../orders/my-orders

üõí Cart Simulation:
  - Using mock cart items
  - Shipping address from user profile
  - Payment method: credit_card
  - Order status: pending

Raw User Data:
${JSON.stringify(user, null, 2)}
            `;
      };

      // Initialize on page load
      checkAuthStatus();
    </script>
  </body>
</html>
