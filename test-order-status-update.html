<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Order Status Update Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f9f9f9;
      }
      .test-button {
        background: #007cba;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .test-button:hover {
        background: #005a87;
      }
      .test-button.admin {
        background: #e74c3c;
      }
      .test-button.admin:hover {
        background: #c0392b;
      }
      .success {
        color: #27ae60;
        font-weight: bold;
      }
      .error {
        color: #e74c3c;
        font-weight: bold;
      }
      .warning {
        color: #f39c12;
        font-weight: bold;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 5px;
        background: #fff;
        border-left: 4px solid #ddd;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 12px;
      }
      .result.success {
        border-left-color: #27ae60;
        background: #f8fff8;
      }
      .result.error {
        border-left-color: #e74c3c;
        background: #fff8f8;
      }
      .config-section {
        background: #e8f4fd;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
      }
      .order-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        background: white;
      }
      .order-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
      }
      .order-item:hover {
        background: #f0f0f0;
      }
      .order-item.selected {
        background: #e8f4fd;
        border-left: 4px solid #007cba;
      }
      .status-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .status-pending {
        background: #fff3cd;
        color: #856404;
      }
      .status-processing {
        background: #cce5ff;
        color: #004085;
      }
      .status-confirmed {
        background: #d4edda;
        color: #155724;
      }
      .status-shipped {
        background: #e2e3e5;
        color: #383d41;
      }
      .status-delivered {
        background: #d1ecf1;
        color: #0c5460;
      }
      .status-cancelled {
        background: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöÄ Order Status Update Test</h1>
      <p>
        Test admin order status update functionality with different endpoints
        and scenarios.
      </p>

      <div class="config-section">
        <h3>üìã Configuration</h3>
        <label for="backendUrl">Backend URL:</label>
        <input
          type="text"
          id="backendUrl"
          value="http://localhost:3000"
          style="width: 200px; margin: 0 10px; padding: 5px"
        />
        <br /><br />
        <label for="adminToken">Admin JWT Token:</label>
        <input
          type="text"
          id="adminToken"
          placeholder="Admin Bearer token"
          style="width: 400px; margin: 0 10px; padding: 5px"
        />
        <br /><br />
        <label for="testOrderId">Test Order ID:</label>
        <input
          type="text"
          id="testOrderId"
          placeholder="Order ID to test with"
          style="width: 300px; margin: 0 10px; padding: 5px"
        />
      </div>

      <!-- Available Orders -->
      <div class="test-section">
        <h3>üì¶ Available Orders</h3>
        <button class="test-button" onclick="loadOrders()">Load Orders</button>
        <div
          id="ordersList"
          class="order-list"
          style="margin-top: 10px; max-height: 200px"
        >
          Click "Load Orders" to see available orders
        </div>
      </div>

      <!-- Status Update Tests -->
      <div class="test-section">
        <h3>üîÑ Status Update Tests</h3>
        <p>Test different order status updates with various endpoints:</p>

        <div style="margin: 10px 0">
          <strong>Quick Status Updates:</strong><br />
          <button
            class="test-button admin"
            onclick="testStatusUpdate('processing')"
          >
            ‚Üí Processing
          </button>
          <button
            class="test-button admin"
            onclick="testStatusUpdate('confirmed')"
          >
            ‚Üí Confirmed
          </button>
          <button
            class="test-button admin"
            onclick="testStatusUpdate('shipped')"
          >
            ‚Üí Shipped
          </button>
          <button
            class="test-button admin"
            onclick="testStatusUpdate('delivered')"
          >
            ‚Üí Delivered
          </button>
          <button
            class="test-button admin"
            onclick="testStatusUpdate('cancelled')"
          >
            ‚Üí Cancelled
          </button>
        </div>

        <div style="margin: 10px 0">
          <strong>Endpoint Tests:</strong><br />
          <button class="test-button" onclick="testEndpoint('/status')">
            Test /:id/status (Correct)
          </button>
          <button class="test-button" onclick="testEndpoint('')">
            Test /:id (Old Way)
          </button>
          <button class="test-button" onclick="testEndpoint('/update-status')">
            Test /:id/update-status
          </button>
          <button class="test-button" onclick="testEndpoint('/payment-status')">
            Test /:id/payment-status
          </button>
        </div>

        <div id="statusUpdateResults"></div>
      </div>

      <!-- Order Management Simulation -->
      <div class="test-section">
        <h3>üéØ Order Management Simulation</h3>
        <p>Simulate the complete order management flow:</p>

        <button class="test-button admin" onclick="simulateOrderFlow()">
          Simulate Complete Order Flow
        </button>
        <button class="test-button" onclick="testOrderCreation()">
          Create Test Order
        </button>
        <button class="test-button" onclick="testBulkStatusUpdate()">
          Bulk Status Update Test
        </button>

        <div id="simulationResults"></div>
      </div>

      <!-- Backend Route Testing -->
      <div class="test-section">
        <h3>üîç Backend Route Testing</h3>
        <p>Test backend route behavior and conflicts:</p>

        <button class="test-button" onclick="testRouteConflicts()">
          Test Route Conflicts
        </button>
        <button class="test-button" onclick="testRoutePriority()">
          Test Route Priority
        </button>
        <button class="test-button" onclick="testAllEndpoints()">
          Test All Endpoints
        </button>

        <div id="routeTestResults"></div>
      </div>

      <div class="test-section">
        <h3>üìù Test Log</h3>
        <div
          id="testLog"
          style="
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
          "
        ></div>
      </div>
    </div>

    <script>
      let selectedOrderId = null;
      let availableOrders = [];

      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById("testLog");
        logElement.textContent += `[${timestamp}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
      }

      function displayResult(
        containerId,
        testName,
        success,
        message,
        details = ""
      ) {
        const container = document.getElementById(containerId);
        const resultClass = success ? "success" : "error";
        const icon = success ? "‚úÖ" : "‚ùå";

        const resultDiv = document.createElement("div");
        resultDiv.className = `result ${resultClass}`;
        resultDiv.innerHTML = `
                <strong>${icon} ${testName}</strong><br>
                ${message}
                ${
                  details
                    ? `<br><small style="color: #666;">${details}</small>`
                    : ""
                }
            `;

        container.appendChild(resultDiv);
      }

      async function makeRequest(method, endpoint, body = null) {
        const backendUrl = document.getElementById("backendUrl").value;
        const adminToken = document.getElementById("adminToken").value;

        const url = `${backendUrl}/api/orders${endpoint}`;

        const options = {
          method,
          headers: {
            "Content-Type": "application/json",
          },
        };

        if (adminToken) {
          options.headers["Authorization"] = adminToken.startsWith("Bearer ")
            ? adminToken
            : `Bearer ${adminToken}`;
        }

        if (body) {
          options.body = JSON.stringify(body);
        }

        log(`Making ${method} request to: ${url}`);

        try {
          const response = await fetch(url, options);
          const data = await response.json();

          log(`Response ${response.status}: ${JSON.stringify(data, null, 2)}`);

          return {
            status: response.status,
            data,
            success: response.ok,
          };
        } catch (error) {
          log(`Request failed: ${error.message}`);
          return {
            status: 0,
            data: { message: error.message },
            success: false,
          };
        }
      }

      async function loadOrders() {
        log("üì¶ Loading available orders...");

        const response = await makeRequest("GET", "/");

        if (response.success && Array.isArray(response.data)) {
          availableOrders = response.data;
          displayOrders(availableOrders);
          log(`‚úÖ Loaded ${availableOrders.length} orders`);
        } else {
          log(`‚ùå Failed to load orders: ${response.data.message}`);
          document.getElementById("ordersList").innerHTML = `
                    <div style="color: #e74c3c; padding: 10px;">
                        Failed to load orders: ${response.data.message}
                    </div>
                `;
        }
      }

      function displayOrders(orders) {
        const container = document.getElementById("ordersList");

        if (orders.length === 0) {
          container.innerHTML =
            '<div style="color: #666;">No orders found</div>';
          return;
        }

        container.innerHTML = orders
          .map(
            (order) => `
                <div class="order-item ${
                  selectedOrderId === order._id ? "selected" : ""
                }" 
                     onclick="selectOrder('${order._id}')">
                    <div style="display: flex; justify-content: between; align-items: center;">
                        <div>
                            <strong>#${order._id?.slice(-8) || "N/A"}</strong>
                            <span class="status-badge status-${
                              order.orderStatus || "pending"
                            }">
                                ${order.orderStatus || "pending"}
                            </span>
                        </div>
                        <div style="margin-left: auto; font-size: 12px; color: #666;">
                            ${order.user?.email || "Unknown"} - $${
              order.totalAmount || 0
            }
                        </div>
                    </div>
                </div>
            `
          )
          .join("");
      }

      function selectOrder(orderId) {
        selectedOrderId = orderId;
        document.getElementById("testOrderId").value = orderId;
        displayOrders(availableOrders);
        log(`Selected order: ${orderId}`);
      }

      function getOrderId() {
        return document.getElementById("testOrderId").value || selectedOrderId;
      }

      async function testStatusUpdate(newStatus) {
        const orderId = getOrderId();

        if (!orderId) {
          alert("Please enter an Order ID or select one from the list");
          return;
        }

        log(`üîÑ Testing status update: ${orderId} ‚Üí ${newStatus}`);

        // Clear previous results
        document.getElementById("statusUpdateResults").innerHTML = "";

        const response = await makeRequest("PATCH", `/${orderId}/status`, {
          status: newStatus,
        });

        const success = response.success;
        const message = success
          ? `‚úÖ Status updated successfully to "${newStatus}"`
          : `‚ùå Failed: ${response.data.message || "Unknown error"}`;

        displayResult(
          "statusUpdateResults",
          `Update to ${newStatus}`,
          success,
          message,
          `Order ID: ${orderId} | Status: ${response.status} | Endpoint: /${orderId}/status`
        );

        // Reload orders to see updated status
        if (success) {
          setTimeout(() => loadOrders(), 1000);
        }
      }

      async function testEndpoint(suffix) {
        const orderId = getOrderId();

        if (!orderId) {
          alert("Please enter an Order ID or select one from the list");
          return;
        }

        log(`üîç Testing endpoint: /${orderId}${suffix}`);

        const response = await makeRequest("PATCH", `/${orderId}${suffix}`, {
          status: "processing",
        });

        const success = response.success;
        const message = success
          ? `‚úÖ Endpoint working: /${orderId}${suffix}`
          : `‚ùå Endpoint failed: ${response.data.message || "Unknown error"}`;

        displayResult(
          "statusUpdateResults",
          `Endpoint Test ${suffix || "(direct)"}`,
          success,
          message,
          `Status: ${response.status} | Full URL: ${
            document.getElementById("backendUrl").value
          }/api/orders/${orderId}${suffix}`
        );
      }

      async function simulateOrderFlow() {
        log("üéØ Starting complete order flow simulation...");

        document.getElementById("simulationResults").innerHTML = "";

        // Test each status transition
        const statusFlow = ["processing", "confirmed", "shipped", "delivered"];

        for (let i = 0; i < statusFlow.length; i++) {
          const status = statusFlow[i];
          const orderId = getOrderId();

          if (!orderId) {
            displayResult(
              "simulationResults",
              "Order Flow",
              false,
              "No order ID provided"
            );
            return;
          }

          log(`Step ${i + 1}: Updating to ${status}...`);

          const response = await makeRequest("PATCH", `/${orderId}/status`, {
            status,
          });

          displayResult(
            "simulationResults",
            `Step ${i + 1}: ${status}`,
            response.success,
            response.success
              ? `‚úÖ Updated to ${status}`
              : `‚ùå Failed: ${response.data.message}`,
            `Status: ${response.status}`
          );

          if (!response.success) {
            log(`‚ùå Order flow stopped at step ${i + 1}`);
            break;
          }

          // Wait between updates
          await new Promise((resolve) => setTimeout(resolve, 1000));
        }

        log("üéØ Order flow simulation complete");
      }

      async function testOrderCreation() {
        log("üìù Creating test order...");

        const testOrder = {
          items: [
            {
              product: "test-product-id",
              name: "Test Product",
              price: 99.99,
              quantity: 1,
            },
          ],
          totalAmount: 99.99,
          shippingAddress: {
            street: "123 Test St",
            city: "Test City",
            state: "TS",
            zipCode: "12345",
            country: "Test Country",
          },
          paymentMethod: "credit_card",
        };

        const response = await makeRequest("POST", "/from-cart", testOrder);

        displayResult(
          "simulationResults",
          "Order Creation",
          response.success,
          response.success
            ? `‚úÖ Order created: ${response.data._id}`
            : `‚ùå Failed: ${response.data.message}`,
          `Status: ${response.status}`
        );

        if (response.success && response.data._id) {
          selectOrder(response.data._id);
          loadOrders();
        }
      }

      async function testBulkStatusUpdate() {
        log("üìä Testing bulk status updates...");

        if (availableOrders.length === 0) {
          displayResult(
            "simulationResults",
            "Bulk Update",
            false,
            "No orders available. Load orders first."
          );
          return;
        }

        // Test updating first 3 orders
        const ordersToTest = availableOrders.slice(0, 3);
        let successCount = 0;

        for (const order of ordersToTest) {
          const response = await makeRequest("PATCH", `/${order._id}/status`, {
            status: "processing",
          });

          if (response.success) {
            successCount++;
          }

          displayResult(
            "simulationResults",
            `Bulk Update ${order._id.slice(-8)}`,
            response.success,
            response.success
              ? "‚úÖ Updated"
              : `‚ùå Failed: ${response.data.message}`,
            `Order: ${order._id.slice(-8)}`
          );

          await new Promise((resolve) => setTimeout(resolve, 500));
        }

        log(
          `üìä Bulk update complete: ${successCount}/${ordersToTest.length} successful`
        );
      }

      async function testRouteConflicts() {
        log("üîç Testing route conflicts...");

        document.getElementById("routeTestResults").innerHTML = "";

        // Test if /my-orders gets caught by /:id route
        const myOrdersResponse = await makeRequest("GET", "/my-orders");

        displayResult(
          "routeTestResults",
          "Route Conflict Test",
          myOrdersResponse.status !== 400 ||
            !myOrdersResponse.data.message?.includes("Invalid order ID"),
          myOrdersResponse.status === 400 &&
            myOrdersResponse.data.message?.includes("Invalid order ID")
            ? "‚ùå Route conflict detected: /my-orders caught by /:orderId"
            : "‚úÖ No route conflict: /my-orders working correctly",
          `Status: ${myOrdersResponse.status} | Message: ${
            myOrdersResponse.data.message || "Success"
          }`
        );
      }

      async function testRoutePriority() {
        log("üìã Testing route priority...");

        const tests = [
          { path: "/", name: "Root (Admin All Orders)" },
          { path: "/my-orders", name: "My Orders (User)" },
          { path: "/from-cart", name: "Create from Cart", method: "POST" },
          { path: "/user/test-user-id", name: "User Orders (Admin)" },
        ];

        for (const test of tests) {
          const method = test.method || "GET";
          const response = await makeRequest(method, test.path);

          displayResult(
            "routeTestResults",
            test.name,
            response.status === 401 ||
              response.status === 403 ||
              response.success,
            `Status: ${response.status} - ${
              response.data.message || "Success"
            }`,
            `Method: ${method} | Path: ${test.path}`
          );
        }
      }

      async function testAllEndpoints() {
        log("üß™ Testing all order endpoints...");

        const endpoints = [
          { method: "GET", path: "/", name: "Get All Orders" },
          { method: "GET", path: "/my-orders", name: "Get My Orders" },
          { method: "POST", path: "/from-cart", name: "Create from Cart" },
          { method: "POST", path: "/direct", name: "Create Direct" },
          { method: "GET", path: "/test-id", name: "Get Order by ID" },
          { method: "PATCH", path: "/test-id/status", name: "Update Status" },
          {
            method: "PATCH",
            path: "/test-id/payment-status",
            name: "Update Payment",
          },
          { method: "DELETE", path: "/test-id", name: "Delete Order" },
        ];

        for (const endpoint of endpoints) {
          const body =
            endpoint.method === "POST"
              ? { test: "data" }
              : endpoint.method === "PATCH"
              ? { status: "test" }
              : null;

          const response = await makeRequest(
            endpoint.method,
            endpoint.path,
            body
          );

          // Consider 401, 403, 404 as expected for test endpoints
          const expectedStatuses = [200, 201, 401, 403, 404];
          const success = expectedStatuses.includes(response.status);

          displayResult(
            "routeTestResults",
            endpoint.name,
            success,
            `Status: ${response.status} - ${
              response.data.message || "Success"
            }`,
            `${endpoint.method} ${endpoint.path}`
          );

          await new Promise((resolve) => setTimeout(resolve, 300));
        }
      }

      // Initialize
      log("Order Status Update Test initialized");
      log("1. Add your admin JWT token");
      log("2. Load orders to see available orders");
      log("3. Select an order or enter an order ID");
      log("4. Test status updates");
    </script>
  </body>
</html>
